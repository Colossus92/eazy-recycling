name: Deploy to Environment (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      image_tag:
        required: true
        type: string
      github_branch:
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v4

      # Generate app.yaml from template using envsubst
      - name: Generate app.yaml from template
        env:
          # Environment-specific configuration
          DO_APP_NAME: ${{ vars.DO_APP_NAME }}
          APP_DOMAIN: ${{ vars.APP_DOMAIN }}
          INSTANCE_SIZE_SLUG: ${{ vars.INSTANCE_SIZE_SLUG }}
          IMAGE_TAG: ${{ inputs.image_tag }}
          GITHUB_BRANCH: ${{ inputs.github_branch }}
          # Secrets
          AMICE_PASSWORD: ${{ secrets.AMICE_PASSWORD }}
          BETTERSTACK_SOURCE_TOKEN: ${{ secrets.BETTERSTACK_SOURCE_TOKEN }}
          CLIENT_PFX_B64: ${{ secrets.CLIENT_PFX_B64 }}
          EXACT_CLIENT_ID: ${{ secrets.EXACT_CLIENT_ID }}
          EXACT_CLIENT_SECRET: ${{ secrets.EXACT_CLIENT_SECRET }}
          TOKEN_ENCRYPTION_KEY: ${{ secrets.TOKEN_ENCRYPTION_KEY }}
          PRICING_APP_BEARER_TOKEN: ${{ secrets.PRICING_APP_BEARER_TOKEN }}
          SPRING_DATASOURCE_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD }}
          SUPABASE_API_JWT_SECRET: ${{ secrets.SUPABASE_API_JWT_SECRET }}
          SUPABASE_API_PUBLISHABLE: ${{ secrets.SUPABASE_API_PUBLISHABLE }}
          SUPABASE_API_SECRET: ${{ secrets.SUPABASE_API_SECRET }}
          # Variables
          VITE_SUPABASE_URL: ${{ vars.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ vars.VITE_SUPABASE_ANON_KEY }}
          VITE_API_URL: ${{ vars.VITE_API_URL }}
          PRICING_APP_BASE_URL: ${{ vars.PRICING_APP_BASE_URL }}
          # Database - Use Session Pooler URL (IPv4), not direct connection (IPv6)
          SPRING_DATASOURCE_URL: ${{ vars.SPRING_DATASOURCE_URL }}
          SPRING_DATASOURCE_USERNAME: ${{ vars.SPRING_DATASOURCE_USERNAME }}
          SUPABASE_API_URL: ${{ vars.SUPABASE_API_URL }}
          SUPABASE_API_JWT_ISSUER: ${{ vars.SUPABASE_API_JWT_ISSUER }}
          AMICE_URL: ${{ vars.AMICE_URL }}
          AMICE_USERNAME: ${{ vars.AMICE_USERNAME }}
          AMICE_ENABLED: ${{ vars.AMICE_ENABLED }}
          AMICE_CERTIFICATE_ENABLED: ${{ vars.AMICE_CERTIFICATE_ENABLED }}
          AMICE_CERTIFICATE_PATH: ${{ vars.AMICE_CERTIFICATE_PATH }}
          EXACT_REDIRECT_URI: ${{ vars.EXACT_REDIRECT_URI }}
          EXACT_DIVISION: ${{ vars.EXACT_DIVISION }}
          FRONTEND_URL: ${{ vars.FRONTEND_URL }}
          PURCHASE_FINANCIAL_EMAIL: ${{ vars.PURCHASE_FINANCIAL_EMAIL }}
          SALES_FINANCIAL_EMAIL: ${{ vars.SALES_FINANCIAL_EMAIL }}
          BETTERSTACK_INGESTING_HOST: ${{ vars.BETTERSTACK_INGESTING_HOST }}
          GHCR_REGISTRY_CREDENTIALS: ${{ vars.GHCR_REGISTRY_CREDENTIALS }}
        run: |
          envsubst < .do/app.yaml.template > .do/app.yaml.generated

      - name: Debug - Print generated app.yaml
        run: |
          echo "=== Generated app.yaml content ==="
          cat .do/app.yaml.generated
          echo "=== End of generated app.yaml ==="

      - name: Deploy the app
        uses: digitalocean/app_action/deploy@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          app_spec_location: .do/app.yaml.generated
          project_id: ${{ vars.DO_PROJECT_ID }}
