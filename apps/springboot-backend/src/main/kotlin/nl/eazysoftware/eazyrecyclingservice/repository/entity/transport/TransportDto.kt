package nl.eazysoftware.eazyrecyclingservice.repository.entity.transport

import jakarta.persistence.*
import nl.eazysoftware.eazyrecyclingservice.domain.model.transport.ContainerOperation
import nl.eazysoftware.eazyrecyclingservice.domain.model.transport.TransportType
import nl.eazysoftware.eazyrecyclingservice.repository.AuditableEntity
import nl.eazysoftware.eazyrecyclingservice.repository.address.PickupLocationDto
import nl.eazysoftware.eazyrecyclingservice.repository.entity.company.CompanyDto
import nl.eazysoftware.eazyrecyclingservice.repository.entity.goods.TransportGoodsDto
import nl.eazysoftware.eazyrecyclingservice.repository.entity.truck.TruckDto
import nl.eazysoftware.eazyrecyclingservice.repository.entity.user.ProfileDto
import nl.eazysoftware.eazyrecyclingservice.repository.wastecontainer.WasteContainerDto
import nl.eazysoftware.eazyrecyclingservice.repository.weightticket.WeightTicketDto
import java.time.Instant
import java.util.*

@Entity
@Table(name = "transports")
data class TransportDto(
  @Id
  val id: UUID,

  /**
   * Human-readable display number in format YY-NNNNNN.
   * Generated by TransportDisplayNumberGenerator for new transports.
   */
  @Column(unique = true, nullable = true)
  val displayNumber: String? = null,

  /**
   * The party client ordering the transport.
   */
  @ManyToOne
  @JoinColumn(name = "consignor_party_id", referencedColumnName = "id")
  val consignorParty: CompanyDto,

  /**
   */
  @ManyToOne
  @JoinColumn(name = "carrier_party_id", referencedColumnName = "id")
  val carrierParty: CompanyDto,

  @OneToOne(fetch = FetchType.LAZY, cascade = [CascadeType.ALL])
  @JoinColumn(name = "pickup_location_id", referencedColumnName = "id")
  val pickupLocation: PickupLocationDto,

  @Embedded
  @AttributeOverrides(
    AttributeOverride(name = "date", column = Column(name = "pickup_date")),
    AttributeOverride(name = "mode", column = Column(name = "pickup_timing_mode")),
    AttributeOverride(name = "windowStart", column = Column(name = "pickup_window_start")),
    AttributeOverride(name = "windowEnd", column = Column(name = "pickup_window_end"))
  )
  val pickupTiming: TimingConstraintDto?,

  @OneToOne(cascade = [CascadeType.ALL])
  @JoinColumn(name = "delivery_location_id", referencedColumnName = "id")
  val deliveryLocation: PickupLocationDto,

  @Embedded
  @AttributeOverrides(
    AttributeOverride(name = "date", column = Column(name = "delivery_date")),
    AttributeOverride(name = "mode", column = Column(name = "delivery_timing_mode")),
    AttributeOverride(name = "windowStart", column = Column(name = "delivery_window_start")),
    AttributeOverride(name = "windowEnd", column = Column(name = "delivery_window_end"))
  )
  val deliveryTiming: TimingConstraintDto?,

  @Enumerated(EnumType.STRING)
  @Column(nullable = true)
  val transportType: TransportType,

  @Enumerated(EnumType.STRING)
  @Column(name = "container_operation", columnDefinition = "container_operations", nullable = true)
  val containerOperation: ContainerOperation? = null,

  @OneToOne
  @JoinColumn(name = "container_id", referencedColumnName = "id")
  val wasteContainer: WasteContainerDto? = null,

  @ManyToOne
  @JoinColumn(name = "truck_id", referencedColumnName = "license_plate", nullable = true)
  val truck: TruckDto? = null,

  @ManyToOne
  @JoinColumn(name = "driver_id", referencedColumnName = "id", nullable = true)
  val driver: ProfileDto? = null,

  val note: String?,

  @ElementCollection(fetch = FetchType.LAZY)
  @CollectionTable(
    name = "transport_goods",
    joinColumns = [JoinColumn(name = "transport_id")]
  )
  val goods: List<TransportGoodsDto>? = null,

  @Column(name = "transport_hours")
  val transportHours: Double? = null,

  @Column(name = "driver_note")
  val driverNote: String? = null,

  @Column(nullable = false)
  var sequenceNumber: Int,

  @ManyToOne
  @JoinColumn(name = "weight_ticket_id", referencedColumnName = "id", nullable = true)
  val weightTicket: WeightTicketDto? = null
) : AuditableEntity() {


  enum class Status {
    UNPLANNED,
    PLANNED,
    FINISHED,
    INVOICED,
  }

  fun getStatus(): Status {
    if (driver == null || truck == null) {
      return Status.UNPLANNED
    }

    if (transportHours != null) {
      return Status.FINISHED
    }

    return Status.PLANNED
  }
}
